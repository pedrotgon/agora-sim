# Story 1.7: fluxo-e2e-criacao-manual

## Status
Draft

## Story
**Como** usuário,\
**Quero** executar um fluxo de ponta a ponta via API que invoque o `aido_orchestrator` para transcrever um vídeo e gerar um novo manual,\
**Para que** eu valide a Jornada 1 do MVP (criação de manual a partir de mídia).

## Acceptance Criteria
1. Um teste de integração chama `/api/projects/{id}/messages` com payload contendo mídia e instruções, e o fluxo aciona `whisper_agent` seguido de `create_agent`. [Fonte: docs/PRD.md#user-journeys; architecture/contratos-de-api.md#contratos-de-api]
2. O fluxo emite eventos SSE (`progress.update`, `manual.ready`) confirmando cada etapa, e o manual final fica acessível via `/api/manuals/{manual_id}`. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]
3. O teste valida que o manual gerado é salvo em `data/uploads/` com metadados locais (ex.: JSON) que simulam `manual_versions`, preparando a transição para persistência no Épico 2. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis; architecture/arquitetura-de-dados.md#modelo-relacional]
4. Logs estruturados e registros do `SessionService` em memória documentam a execução para auditoria básica. [Fonte: architecture/regras-de-consistencia.md#regras-de-consistencia; refs/adk_training-main/docs/docs/08_state_memory.md#session-state]

## Tasks / Subtasks
- [ ] Preparar fixtures de mídia e instruções para o teste integrado. [Fonte: docs/PRD.md#user-journeys]
- [ ] Escrever teste em `tests/integration/workflows/test_end_to_end_create.py` simulando o fluxo completo. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- [ ] Validar eventos SSE e conteúdo do `.docx` gerado (metadados básicos). [Fonte: architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
- [ ] Verificar que os arquivos gerados e metadados locais foram criados corretamente após o fluxo. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
- [ ] Garantir limpeza/isolamento de dados de teste em `data/uploads/` e em estruturas em memória. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
- [ ] Documentar o procedimento de execução do teste para futuras regressões. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

## Dev Notes
### Previous Story Insights
Baseia-se nos agentes e registro configurados nas Histórias 1.2 a 1.6; confirma a Jornada 1 do PRD. [Fonte: docs/stories/1.2.aido-orchestrator-workflow-agent.md; docs/stories/1.6.registro-de-ferramentas-adk.md; docs/PRD.md#user-journeys]

### Data Models
- Utilizar metadados temporários compatíveis com `projects`, `uploads` e `manual_versions`, mantidos em memória ou arquivos auxiliares até a implementação do Épico 2. [Fonte: architecture/arquitetura-de-dados.md#modelo-relacional]

### API Specifications
- Endpoints: `/api/projects`, `/api/projects/{id}/uploads`, `/api/projects/{id}/messages`, `/api/projects/{id}/stream`, `/api/manuals/{manual_id}`. [Fonte: architecture/contratos-de-api.md#contratos-de-api]

### Component Specifications
- Utiliza FastAPI + Uvicorn e WorkflowAgent com ferramentas registradas. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- SSE processado via cliente `EventSource` simulando UI. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

### File Locations
- Teste integrado: `tests/integration/workflows/test_end_to_end_create.py`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Fixtures: `tests/fixtures/media/` (se necessário). [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]

### Testing
- Executar `pytest tests/integration/workflows/test_end_to_end_create.py` garantindo tempo total <5 min. [Fonte: architecture/consideracoes-de-performance.md#consideracoes-de-performance]
- Validar consistência do `.docx` com `python-docx` e metadados gerados. [Fonte: architecture/resumo-das-decisoes.md#resumo-das-decisoes]

### Technical Constraints
- Fluxo rodando 100% local, com dependências pré-instaladas (FFmpeg, docxtpl). [Fonte: architecture/ambiente-de-desenvolvimento.md#pre-requisitos]
- Manter confidencialidade, sem upload para serviços externos durante testes. [Fonte: architecture/arquitetura-de-seguranca.md#arquitetura-de-seguranca]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-31 | 1.0 | Rascunho inicial | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

