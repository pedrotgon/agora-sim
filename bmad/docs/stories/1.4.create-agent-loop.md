# Story 1.4: create-agent-loop

## Status
Draft

## Story
**Como** desenvolvedor,\
**Quero** implementar o `create_agent` como um `LoopAgent` que transforma transcrições e instruções em um dicionário estruturado e gera um `.docx` usando `docxtpl`,\
**Para que** o sistema produza manuais padronizados automaticamente.

## Acceptance Criteria
1. O `create_agent` é implementado como `LoopAgent` em `packages/agents/create_agent/`, obedecendo ao fluxo `structuring -> rendering -> validating`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto; architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
2. O agente cria um dicionário `context` a partir do texto recebido, pronto para preencher o template corporativo. [Fonte: architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
3. `docxtpl` preenche `data/templates/Padronizacao_Manuais.docx`, salvando o arquivo final em `data/uploads/` e registrando metadados localmente (versão, hash) para futura integração com banco. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto; architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
4. A execução publica eventos (`structuring`, `rendering`, `manual_ready`) e retorna o caminho final ao orquestrador, mantendo logs estruturados. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

## Tasks / Subtasks
- [ ] Configurar `LoopAgent` em `packages/agents/create_agent/agent.py` com etapas enumeradas. [Fonte: architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
- [ ] Implementar transformação de texto em dicionário `context` usando LLM local ou serviços definidos. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#integracoes-internas]
- [ ] Integrar `docxtpl` e template corporativo, salvando saídas em `data/uploads/` com metadados locais (JSON/csv) que imitam `manual_versions`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- [ ] Emitir eventos ADK (`structuring`, `rendering`, `manual_ready`) e logs estruturados. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]
- [ ] Escrever testes unitários/integrados cobrindo geração de dicionário e `.docx`. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- [ ] Documentar o fluxo no README do agente destacando como a persistência real será plugada no Épico 2. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

## Dev Notes
### Previous Story Insights
Depende das transcrições fornecidas pelo `whisper_agent` (História 1.3) e da orquestração construída na História 1.2. [Fonte: docs/stories/1.2.aido-orchestrator-workflow-agent.md; docs/stories/1.3.whisper-agent-sequential.md]

### Data Models
- Estrutura de metadados compatível com `manual_versions` (id, project, version, docx_path), persistida localmente durante o Épico 1 e migrada para banco no Épico 2. [Fonte: architecture/arquitetura-de-dados.md#modelo-relacional]

### API Specifications
- Sem endpoint dedicado; o resultado será entregue ao orquestrador e exposto via `/api/manuals/{manual_id}`. [Fonte: architecture/contratos-de-api.md#contratos-de-api]

### Component Specifications
- Agente localizado em `packages/agents/create_agent/`, reutilizando utilitários compartilhados (templating, validações). [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Uso de `FileArtifactService` para armazenar artefatos temporários e manter integridade. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]

### File Locations
- Código do agente: `packages/agents/create_agent/agent.py`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Template de entrada: `data/templates/Padronizacao_Manuais.docx`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Saída (`.docx`): `data/uploads/{project}/`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]

### Testing
- Testar geração de `context` e docx com `pytest`, incluindo cenários de campos obrigatórios ausentes. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- Validar integridade do arquivo gerado (hash/abre sem erros) e consistência dos metadados locais. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]

### Technical Constraints
- Execução local, usando `docxtpl 0.16+` e `python-docx`. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- Garantir que somente arquivos aprovados sejam gravados em `data/uploads/` e que hashes sejam calculados. [Fonte: architecture/arquitetura-de-seguranca.md#arquitetura-de-seguranca]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-31 | 1.0 | Rascunho inicial | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

