# Story 1.5: update-agent-loop

## Status
Draft

## Story
**Como** desenvolvedor,\
**Quero** implementar o `update_agent` como um `LoopAgent` capaz de atualizar um `.docx` existente com novas instruções e transcrições,\
**Para que** o sistema mantenha manuais corporativos atualizados de forma automatizada.

## Acceptance Criteria
1. O `update_agent` é implementado como `LoopAgent` em `packages/agents/update_agent/`, reutilizando o ciclo `structuring -> rendering -> validating`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto; architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
2. O agente recebe o caminho de um `.docx` existente, integra novas instruções/transcrições e produz um `context` atualizado. [Fonte: architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
3. A geração de docx utiliza `docxtpl`, preserva o template `Padronizacao_Manuais.docx` e cria nova versão em `data/uploads/`, atualizando metadados locais para versionamento. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto; architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
4. O fluxo publica eventos de progresso e registra logs estruturados, mantendo a interface para futura persistência em `manual_versions`. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

## Tasks / Subtasks
- [ ] Implementar `LoopAgent` em `packages/agents/update_agent/agent.py` aproveitando utilitários compartilhados. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- [ ] Carregar manual existente (`.docx`), extrair contexto e mesclar com novas instruções/transcrições. [Fonte: architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]
- [ ] Gerar docx atualizado via `docxtpl`, salvando em `data/uploads/` com versionamento e hash registrados localmente (arquivo de metadados). [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
- [ ] Emitir eventos (`structuring`, `rendering`, `manual_ready`) e logs estruturados. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]
- [ ] Escrever testes cobrindo atualização incremental e erros de merge/integridade. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- [ ] Documentar no README do agente como o versionamento será migrado para banco no Épico 2. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

## Dev Notes
### Previous Story Insights
O fluxo reutiliza componentes do `create_agent` e depende de transcrições via `whisper_agent`. Mantenha interfaces compatíveis com a História 1.2. [Fonte: docs/stories/1.2.aido-orchestrator-workflow-agent.md; docs/stories/1.4.create-agent-loop.md]

### Data Models
- Metadados alinhados a `manual_versions` (versionamento, referências) mantidos em arquivo local durante o Épico 1 para facilitar migração futura. [Fonte: architecture/arquitetura-de-dados.md#modelo-relacional]
- `uploads`: garantir que os arquivos atualizados fiquem em `data/uploads/{project}/` para rastreamento. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]

### API Specifications
- O orquestrador expõe o resultado via `/api/manuals/{manual_id}` após integração; não há endpoint direto para o agente. [Fonte: architecture/contratos-de-api.md#contratos-de-api]

### Component Specifications
- Localizado em `packages/agents/update_agent/`, compartilhando libs de parsing/docx com `packages/agents/shared/`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Deve suportar uploads múltiplos (texto + mídia) conforme Jornada 2. [Fonte: docs/PRD.md#user-journeys]

### File Locations
- Código do agente: `packages/agents/update_agent/agent.py`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Docx base: `data/templates/Padronizacao_Manuais.docx`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Saída: `data/uploads/{project}/manual_v{n}.docx`. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]

### Testing
- Testar merges com novos capítulos, anexos e conflitos de instruções usando `pytest`. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- Garantir que o manual atualizado mantenha formatação e referências internas, validando abertura via `python-docx`. [Fonte: architecture/resumo-das-decisoes.md#resumo-das-decisoes]

### Technical Constraints
- Operar localmente, respeitando armazenamento seguro e limpeza de temporários em `data/uploads/`. [Fonte: architecture/arquitetura-de-seguranca.md#arquitetura-de-seguranca]
- Preservar histórico e integridade com hashing SHA256 por arquivo, ainda que metadados fiquem em arquivo auxiliar no Épico 1. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-31 | 1.0 | Rascunho inicial | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

