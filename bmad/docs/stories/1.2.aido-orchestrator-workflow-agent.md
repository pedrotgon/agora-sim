# Story 1.2: aido-orchestrator-workflow-agent

## Status
Ready for Review

## Story
**Como** desenvolvedor,\
**Quero** implementar o `aido_orchestrator` como um `WorkflowAgent` no Google ADK, capaz de gerenciar estado de conversa e coordenar os demais agentes como ferramentas,\
**Para que** o fluxo principal do MVP funcione localmente com baixa latência e rastreabilidade.

## Acceptance Criteria
1. O orquestrador é implementado como `WorkflowAgent` em `packages/orchestrator/app/workflows/aido_orchestrator.py`, inicializando o runtime ADK local com as dependências definidas. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto; architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
2. O agente mantém estado conversacional usando um `SessionService` configurável, operando inicialmente com `InMemorySessionService` e preparado para troca por persistência no Épico 2. [Fonte: refs/adk_training-main/docs/docs/08_state_memory.md#session-state; architecture/resumo-das-decisoes.md#resumo-das-decisoes]
3. Durante a execução, o orquestrador emite eventos padronizados (`progress.update`, `manual.ready`) para SSE e logging estruturado. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]
4. A integração com FastAPI expõe endpoints REST e SSE previstos, com logging `structlog` e operação 100% local. [Fonte: architecture/contratos-de-api.md#contratos-de-api; architecture/regras-de-consistencia.md#regras-de-consistencia]

## Tasks / Subtasks
- [x] Definir a classe `WorkflowAgent` do orquestrador em `packages/orchestrator/app/workflows/aido_orchestrator.py`, configurando runtime e dependências ADK. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- [x] Encapsular o uso de `SessionService`, iniciando com `InMemorySessionService` e prevendo ponto de troca para persistência futura. [Fonte: refs/adk_training-main/docs/docs/08_state_memory.md#session-state]
- [x] Mapear emissão de eventos ADK em SSE (`progress.update`, `manual_ready`) e logging estruturado. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]
- [x] Criar adaptadores FastAPI em `packages/orchestrator/app/api/` para iniciar workflows e expor streams SSE. [Fonte: architecture/contratos-de-api.md#contratos-de-api]
- [x] Configurar `structlog` com campos obrigatórios (`session_id`, `workflow_step`) e garantir execução local segura. [Fonte: architecture/regras-de-consistencia.md#regras-de-consistencia; architecture/arquitetura-de-seguranca.md#arquitetura-de-seguranca]
- [x] Construir testes de integração em `tests/integration/` validando ciclo completo do orquestrador com estado em memória. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]

## Dev Notes
### Previous Story Insights
A História 1.1 estruturou os diretórios em `packages/agents/` e `packages/orchestrator/`, permitindo configurar o WorkflowAgent diretamente. [Fonte: docs/stories/1.1.configuracao-estrutura-pastas.md]

### Data Models
- Estado volátil via `InMemorySessionService`, preservando interface para futura persistência em `sessions` e `events` quando o Épico 2 entrar em vigor. [Fonte: refs/adk_training-main/docs/docs/08_state_memory.md#session-state]

### API Specifications
- `/api/projects/{id}/messages`: recebe solicitações, dispara o WorkflowAgent e retorna `message_id`. [Fonte: architecture/contratos-de-api.md#contratos-de-api]
- `/api/projects/{id}/stream`: canal SSE com eventos `progress.update` e `manual_ready`. [Fonte: architecture/contratos-de-api.md#contratos-de-api]

### Component Specifications
- Workflow principal definido em `packages/orchestrator/app/workflows/`, com suporte de serviços em `app/services/`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Integração FastAPI executada a partir de `packages/orchestrator/main.py` com Uvicorn. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]

### File Locations
- Orquestrador em `packages/orchestrator/app/workflows/aido_orchestrator.py`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Endpoints FastAPI em `packages/orchestrator/app/api/`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Logging configurado em `packages/orchestrator/app/services/` (estrutura indicada). [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]

### Testing
- Utilizar `pytest` + `httpx` para validar chamadas REST/SSE e o ciclo de vida do WorkflowAgent com `InMemorySessionService`, garantindo trilha clara para migração ao serviço persistente. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- Registrar evidências de teste em logs estruturados para inspeção posterior. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

### Technical Constraints
- Executar localmente com `google-adk[database]` 1.17+, FastAPI 0.111+, Uvicorn 0.30+, sem tráfego externo. [Fonte: architecture/detalhes-da-pilha-tecnologica.md#tecnologias-centrais]
- O `.env` com chaves e sinalização de Vertex AI desativado será fornecido manualmente pelo time; garantir carregamento seguro conforme diretrizes de segurança. [Fonte: architecture/arquitetura-de-seguranca.md#arquitetura-de-seguranca]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-31 | 1.0 | Rascunho inicial | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Codex CLI)

### Debug Log References
- `pytest aido/tests/integration/test_orchestrator.py`

### Completion Notes List
- Implementado WorkflowAgent com sessões in-memory, normalização de eventos e agente bootstrap para o MVP.
- Endpoints FastAPI (`/messages`, `/stream`) com resposta SSE e logging padronizado.
- Testes de integração garantindo fluxo completo e compatibilidade futura com persistência.

### File List
- `aido/__init__.py`
- `aido/packages/__init__.py`
- `aido/packages/README.md`
- `aido/packages/orchestrator/__init__.py`
- `aido/packages/orchestrator/app/__init__.py`
- `aido/packages/orchestrator/app/api/__init__.py`
- `aido/packages/orchestrator/app/api/app.py`
- `aido/packages/orchestrator/app/api/dependencies.py`
- `aido/packages/orchestrator/app/api/routes.py`
- `aido/packages/orchestrator/app/services/__init__.py`
- `aido/packages/orchestrator/app/services/logging.py`
- `aido/packages/orchestrator/app/services/session.py`
- `aido/packages/orchestrator/app/workflows/__init__.py`
- `aido/packages/orchestrator/app/workflows/aido_orchestrator.py`
- `aido/tests/__init__.py`
- `aido/tests/integration/__init__.py`
- `aido/tests/integration/test_orchestrator.py`

## QA Results
