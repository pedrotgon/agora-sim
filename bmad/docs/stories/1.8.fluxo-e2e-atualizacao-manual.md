# Story 1.8: fluxo-e2e-atualizacao-manual

## Status
Draft

## Story
**Como** usuário,\
**Quero** executar um fluxo de ponta a ponta via API que invoque o `aido_orchestrator` para atualizar um manual `.docx` existente com novas instruções,\
**Para que** eu valide a Jornada 2 do MVP (atualização de manual).

## Acceptance Criteria
1. Um teste de integração dispara o fluxo com upload de `.docx` existente e novas instruções, acionando `update_agent` (e `whisper_agent` se necessário). [Fonte: docs/PRD.md#user-journeys]
2. O SSE emite eventos (`progress.update`, `manual.ready`) confirmando cada etapa de atualização, e o novo manual é acessível via `/api/manuals/{manual_id}`. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]
3. O teste valida que o versionamento local foi incrementado (metadados auxiliares) e que o arquivo atualizado está em `data/uploads/`. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
4. Logs estruturados e registros do `SessionService` em memória comprovam rastreabilidade do fluxo. [Fonte: architecture/regras-de-consistencia.md#regras-de-consistencia; refs/adk_training-main/docs/docs/08_state_memory.md#session-state]

## Tasks / Subtasks
- [ ] Preparar fixture de manual base e instruções de atualização. [Fonte: docs/PRD.md#user-journeys]
- [ ] Escrever teste em `tests/integration/workflows/test_end_to_end_update.py` cobrindo o fluxo completo. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- [ ] Validar geração de nova versão nos metadados locais e existência do arquivo em `data/uploads/`. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
- [ ] Confirmar eventos SSE e logs estruturados com `session_id`, `workflow_step`. [Fonte: architecture/regras-de-consistencia.md#regras-de-consistencia]
- [ ] Garantir rollback/limpeza de dados de teste e anexos temporários. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]
- [ ] Documentar roteiro de validação do fluxo para regressões futuras. [Fonte: architecture/padroes-de-implementacao-anti-conflito.md#padroes-de-implementacao-anti-conflito]

## Dev Notes
### Previous Story Insights
Requer agentes e registro das Histórias 1.2 a 1.6 e complementa o fluxo validado na História 1.7. [Fonte: docs/stories/1.6.registro-de-ferramentas-adk.md; docs/stories/1.7.fluxo-e2e-criacao-manual.md]

### Data Models
- Metadados temporários compatíveis com `manual_versions` garantem rastreabilidade até que a persistência do Épico 2 seja implementada. [Fonte: architecture/arquitetura-de-dados.md#modelo-relacional]
- `uploads`: confirmar armazenamento de docx atualizado e arquivos de referência em `data/uploads/`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]

### API Specifications
- Endpoints: `/api/projects`, `/api/projects/{id}/uploads`, `/api/projects/{id}/messages`, `/api/projects/{id}/stream`, `/api/manuals/{manual_id}`. [Fonte: architecture/contratos-de-api.md#contratos-de-api]

### Component Specifications
- Fluxo utiliza `update_agent` e potencialmente `whisper_agent` via WorkflowAgent. [Fonte: docs/PRD.md#user-journeys; architecture/padroes-inovadores.md#loop-de-sintese-de-manuais]

### File Locations
- Teste integrado: `tests/integration/workflows/test_end_to_end_update.py`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]
- Fixtures: `tests/fixtures/manuals/` e `tests/fixtures/instructions/`. [Fonte: architecture/estrutura-de-projeto.md#estrutura-de-projeto]

### Testing
- Executar `pytest` no fluxo de atualização garantindo tempo <5 min e integridade do manual resultante. [Fonte: architecture/consideracoes-de-performance.md#consideracoes-de-performance]
- Validar integridade do docx (abre sem erros, contém novas seções) e consistência dos metadados locais. [Fonte: architecture/resumo-das-decisoes.md#resumo-das-decisoes]

### Technical Constraints
- Execução totalmente local, preservando confidencialidade e versionamento seguro em `data/uploads/`. [Fonte: architecture/arquitetura-de-seguranca.md#arquitetura-de-seguranca]
- Garantir limpeza de arquivos temporários e hashes atualizados mesmo sem persistência centralizada. [Fonte: architecture/padroes-inovadores.md#sincronizacao-de-artefatos-sensiveis]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-31 | 1.0 | Rascunho inicial | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

